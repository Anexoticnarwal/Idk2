<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Goal Tracker — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .details-container { max-height: 0; opacity: 0; transition: max-height 0.36s ease-in-out, opacity 0.28s ease-in-out; overflow: hidden; }
        .details-container.expanded { max-height: 2000px; opacity: 1; padding-top: 0.5rem; }
        .form-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border-color: #3b82f6; }
        .toggle-step { accent-color: #059669; }
        /* PowerBI-like large tile visuals */
        .goal-tile { min-height: 150px; display: flex; flex-direction: column; justify-content: space-between; }
        .kpi-big { font-size: 1.7rem; line-height: 1; }
        .tile-scroll { max-height: 360px; overflow-y: auto; padding-right: 6px; }
        @media (min-width: 1024px) {
            /* make tiles slightly larger on wide screens */
            .goal-tile { min-height: 170px; }
        }
    </style>
</head>
<body class="min-h-screen">
    <main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <!-- Top summary and controls -->
        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800">Goal Dashboard</h1>
                <p class="text-sm text-gray-500 mt-1">Side-by-side panels for Daily and Long‑term goals. Works on mobile (stacked).</p>
            </div>
            <div class="flex items-center gap-3">
                <div id="summary-daily" class="text-center px-3 py-2 rounded-lg bg-emerald-50 border border-emerald-100">
                    <div class="text-xs text-emerald-700 font-semibold">Daily</div>
                    <div id="summary-daily-count" class="font-bold text-emerald-800">0</div>
                </div>
                <div id="summary-long" class="text-center px-3 py-2 rounded-lg bg-indigo-50 border border-indigo-100">
                    <div class="text-xs text-indigo-700 font-semibold">Long‑term</div>
                    <div id="summary-long-count" class="font-bold text-indigo-800">0</div>
                </div>
            </div>
        </div>

        <!-- Panels: side-by-side on wide screens, stacked on mobile -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- DAILY GOALS PANEL -->
            <section id="daily-panel" class="bg-white p-4 rounded-2xl shadow-xl border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-emerald-700">Daily Goals</h2>
                    <div class="text-sm text-gray-500" id="daily-subtext">Today: <span id="daily-today-completed">0</span>/<span id="daily-today-total">0</span></div>
                </div>

                <div id="daily-goals-list" class="grid grid-cols-1 gap-4">
                    <!-- Daily goal tiles inserted here -->
                </div>
            </section>

            <!-- LONG-TERM GOALS PANEL -->
            <section id="long-panel" class="bg-white p-4 rounded-2xl shadow-xl border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-indigo-700">Long‑term Goals</h2>
                    <div class="text-sm text-gray-500" id="long-subtext">Overall Progress</div>
                </div>

                <div id="longterm-goals-list" class="grid grid-cols-1 gap-4">
                    <!-- Long-term goal tiles inserted here -->
                </div>
            </section>
        </div>

        <!-- GOAL CREATION FORM (stays below panels) -->
        <div id="add-goal-container" class="bg-white p-4 rounded-2xl shadow-xl border border-gray-100">
            <div class="flex justify-between items-center mb-1 pb-1 border-b">
                <h2 class="text-xl font-bold text-gray-800">New Goal</h2>
                <button id="toggle-add-form" type="button" class="p-1 text-gray-600 hover:text-blue-600 rounded-full transition duration-150" aria-label="Toggle Form">
                    <svg class="w-6 h-6 rotate-180 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
            </div>

            <div id="add-goal-form-content" class="details-container expanded">
                <form id="add-goal-form" class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <label for="goal-name" class="block text-sm font-medium text-gray-700 mb-1">Goal Name</label>
                            <input id="goal-name" type="text" placeholder="e.g., Read for 20 minutes" class="form-input w-full p-2 border border-gray-300 rounded-xl text-sm" />
                        </div>

                        <div>
                            <label for="goal-type" class="block text-sm font-medium text-gray-700 mb-1">Goal Type</label>
                            <select id="goal-type" class="form-input w-full p-2 border border-gray-300 rounded-xl text-sm">
                                <option value="daily" selected>Daily</option>
                                <option value="longterm">Long‑term</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="w-full sm:w-1/2">
                            <label for="goal-start" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input id="goal-start" type="date" class="form-input w-full p-2 border border-gray-300 rounded-xl text-sm" />
                        </div>
                        <div class="w-full sm:w-1/2">
                            <label for="goal-end" class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
                            <input id="goal-end" type="date" class="form-input w-full p-2 border border-gray-300 rounded-xl text-sm" />
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                        <div id="tasks-draft-container" class="details-container expanded">
                            <ul id="steps-draft-list" class="space-y-1 max-h-40 overflow-y-auto pr-2"></ul>

                            <div class="space-y-2 pt-1 border-t border-gray-200">
                                <div>
                                    <label for="new-step-desc" class="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                                    <input id="new-step-desc" type="text" placeholder="e.g., Do 20 pushups" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm" />
                                </div>

                                <div class="flex space-x-3">
                                    <div class="w-1/2">
                                        <label for="new-step-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                        <input id="new-step-start-date" type="date" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm"/>
                                    </div>
                                    <div class="w-1/2">
                                        <label for="new-step-end-date" class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
                                        <input id="new-step-end-date" type="date" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm"/>
                                    </div>
                                </div>

                                <div class="flex items-center pt-1">
                                    <input id="new-step-recurring" type="checkbox" class="h-4 w-4 text-emerald-600 rounded toggle-step" />
                                    <label for="new-step-recurring" class="ml-2 block text-sm font-medium text-gray-700">Daily Recurring Task</label>
                                </div>

                                <button type="button" id="add-step-draft-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium text-sm py-2 rounded-xl transition duration-200">
                                    Add Task
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-gray-50 rounded-xl shadow-inner border border-gray-200 mt-3">
                        <button type="button" id="toggle-notes" class="w-full text-left flex justify-between items-center text-sm font-bold text-gray-700 hover:text-blue-600 transition duration-150">
                            <span>Notes</span>
                            <svg class="w-5 h-5 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="notes-container" class="details-container">
                            <textarea id="goal-notes" rows="3" placeholder="Context or key resources..." class="notes-textarea form-input w-full p-2 border border-gray-300 rounded-xl text-sm mt-2"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold text-lg py-3 rounded-xl transition duration-200 shadow-lg mt-4">
                        CREATE GOAL
                    </button>
                </form>
            </div>
        </div>

        <!-- CONFIRMATION MODAL -->
        <div id="confirmation-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4" aria-modal="true" role="dialog">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6" role="document">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition shadow-md">Confirm</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="max-w-6xl mx-auto px-4 py-4 text-center text-xs text-gray-400 border-t mt-8">
        Built with ❤️ — responsive side-by-side dashboard
    </footer>

    <script>
        // Local storage key
        const LOCAL_STORAGE_KEY = 'goalTrackerData_v2';
        let goals = [];
        let stepsDraft = [];

        const loadGoals = () => {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            goals = data ? JSON.parse(data) : [];
        };

        const saveGoals = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(goals));
            renderGoals();
        };

        const generateId = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
            return dateString;
        };

        const getTodayDateString = () => new Date().toISOString().slice(0,10);

        const showStatusMessage = (msg) => console.warn('STATUS:', msg);

        /**
         * Calculate progress with differences for daily vs long-term:
         * - daily: completed today / total steps
         * - longterm: completed non-recurring steps / total non-recurring steps (fallback to today's completions if none non-recurring)
         */
        const calculateProgress = (goal) => {
            const totalSteps = goal.steps.length;
            const today = getTodayDateString();

            if (totalSteps === 0) return { progressPercent: 0, completedToday: 0, totalSteps: 0 };

            // Count completed today (for recurring and one-off)
            const completedToday = goal.steps.reduce((count, step) => {
                const isDoneToday = step.isRecurring
                    ? (step.completionLog && step.completionLog.includes(today))
                    : step.isCompleted;
                return count + (isDoneToday ? 1 : 0);
            }, 0);

            if (goal.type === 'daily') {
                const progressPercent = Math.round((completedToday / totalSteps) * 100);
                return { progressPercent, completedToday, totalSteps };
            } else { // longterm
                const nonRecurring = goal.steps.filter(s => !s.isRecurring);
                if (nonRecurring.length > 0) {
                    const completedNonRecurring = nonRecurring.reduce((c, s) => c + (s.isCompleted ? 1 : 0), 0);
                    const progressPercent = Math.round((completedNonRecurring / nonRecurring.length) * 100);
                    return { progressPercent, completedToday, totalSteps: nonRecurring.length, completedNonRecurring };
                } else {
                    // fallback to daily style if no non-recurring tasks exist
                    const progressPercent = Math.round((completedToday / totalSteps) * 100);
                    return { progressPercent, completedToday, totalSteps };
                }
            }
        };

        // RENDERING

        const renderGoals = () => {
            const dailyContainer = document.getElementById('daily-goals-list');
            const longContainer = document.getElementById('longterm-goals-list');
            dailyContainer.innerHTML = '';
            longContainer.innerHTML = '';

            // split goals by type
            const dailyGoals = goals.filter(g => g.type === 'daily');
            const longGoals = goals.filter(g => g.type === 'longterm');

            // Summary counts
            document.getElementById('summary-daily-count').textContent = dailyGoals.length;
            document.getElementById('summary-long-count').textContent = longGoals.length;

            // Totals for top-right subtexts
            const dailyTotals = dailyGoals.reduce((acc, g) => {
                const p = calculateProgress(g);
                acc.completed += p.completedToday || 0;
                acc.total += (p.totalSteps || g.steps.length);
                return acc;
            }, {completed: 0, total: 0});
            document.getElementById('daily-today-completed').textContent = dailyTotals.completed;
            document.getElementById('daily-today-total').textContent = dailyTotals.total;

            // Render daily tiles (if none show hint)
            if (dailyGoals.length === 0) {
                dailyContainer.innerHTML = `
                    <div class="p-8 bg-gray-50 rounded-xl border border-dashed border-gray-200 text-center text-gray-500">
                        No daily goals yet — create one below.
                    </div>
                `;
            } else {
                dailyGoals.forEach(g => dailyContainer.appendChild(createGoalElement(g)));
            }

            if (longGoals.length === 0) {
                longContainer.innerHTML = `
                    <div class="p-8 bg-gray-50 rounded-xl border border-dashed border-gray-200 text-center text-gray-500">
                        No long‑term goals yet — create one below.
                    </div>
                `;
            } else {
                longGoals.forEach(g => longContainer.appendChild(createGoalElement(g)));
            }
        };

        const handleToggleNestedDetails = (button, contentId) => {
            const content = document.getElementById(contentId);
            const svg = button.querySelector('svg');
            if (!content) return;
            content.classList.toggle('expanded');
            if (svg) svg.classList.toggle('rotate-180');
            button.setAttribute('aria-expanded', content.classList.contains('expanded'));
        };

        // returns a DOM element for a goal (tile)
        const createGoalElement = (goal) => {
            const { progressPercent, completedToday, totalSteps } = calculateProgress(goal);
            const isCompleted = progressPercent === 100;
            const today = getTodayDateString();
            const color = goal.type === 'daily' ? 'emerald' : 'indigo';
            const tile = document.createElement('div');

            // tile container
            tile.className = `goal-tile p-4 rounded-xl border-t-4 border-${color}-500 bg-white shadow-lg flex flex-col justify-between`;
            tile.setAttribute('data-goal-id', goal.id);

            // Steps list (small) and other content created as innerHTML
            const stepsHtml = goal.steps.length > 0 ? goal.steps.map(step => {
                const isDoneToday = step.isRecurring
                    ? (step.completionLog && step.completionLog.includes(today))
                    : step.isCompleted;

                const recurringTag = step.isRecurring ? `<span class="text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-0.5 rounded-full ml-2">Daily</span>` : '';
                const dates = (step.startDate || step.endDate) ? `<div class="text-xs text-gray-400 mt-1">Start: ${formatDate(step.startDate)} · Target: ${formatDate(step.endDate)}</div>` : '';

                return `
                    <li data-step-id="${step.id}" class="flex items-start p-2 bg-gray-50 rounded-lg border border-gray-100 mb-1">
                        <input type="checkbox" ${isDoneToday ? 'checked' : ''} onchange="handleToggleStep('${goal.id}','${step.id}', this.checked)" class="toggle-step h-4 w-4 text-emerald-600 mt-1 mr-3" title="${step.isRecurring ? 'Mark complete for today' : 'Mark as complete'}"/>
                        <div class="text-sm min-w-0">
                            <div class="${isDoneToday ? 'line-through text-gray-400' : 'text-gray-700'} font-medium">${step.description} ${recurringTag}</div>
                            ${dates}
                        </div>
                    </li>
                `;
            }).join('') : '<div class="text-sm text-gray-500 italic">No tasks yet.</div>';

            // Choose a compact or expanded look based on goal.isExpanded
            const isExpanded = !!goal.isExpanded;

            tile.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1 pr-3">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-bold text-gray-800 truncate ${isCompleted ? 'line-through text-gray-500' : ''}">${goal.name}</h3>
                            <span class="text-xs font-medium text-${color}-700 bg-${color}-100 px-2 py-0.5 rounded-full">${goal.type === 'daily' ? 'Daily' : 'Long'}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Start: ${formatDate(goal.startDate)} • Target: ${formatDate(goal.endDate)}</p>
                    </div>

                    <div class="flex flex-col items-end justify-between">
                        <div class="text-sm text-gray-500">${completedToday}/${totalSteps}</div>
                        <div class="kpi-big text-${color}-600 font-extrabold">${progressPercent}%</div>
                    </div>
                </div>

                <div class="mt-3 tile-scroll">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Tasks</h4>
                    <ul class="mb-2">
                        ${stepsHtml}
                    </ul>
                </div>

                <div class="mt-3">
                    <div class="goal-details-content details-container ${isExpanded ? 'expanded' : ''}">
                        <div class="mb-3 p-3 bg-white rounded-xl space-y-3 shadow-sm border border-gray-200">
                            <button type="button" data-goal-id="${goal.id}" onclick="handleToggleNestedDetails(this, 'add-task-form-content-${goal.id}')" class="w-full text-left flex justify-between items-center text-sm font-bold text-${color}-700 hover:text-${color}-600 transition duration-150 mb-2">
                                <span>+ Add New Task</span>
                                <svg class="w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            </button>
                            <div id="add-task-form-content-${goal.id}" class="details-container">
                                <div class="space-y-3 pt-1">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Description</label>
                                        <input id="new-task-desc-${goal.id}" type="text" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Write 500 words"/>
                                    </div>
                                    <div class="flex space-x-3">
                                        <div class="w-1/2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                            <input id="new-task-start-date-${goal.id}'" type="date" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm"/>
                                        </div>
                                        <div class="w-1/2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Target Date</label>
                                            <input id="new-task-end-date-${goal.id}" type="date" class="form-input w-full p-2 border border-gray-300 rounded-lg text-sm"/>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="new-task-recurring-${goal.id}" type="checkbox" class="h-4 w-4 text-emerald-600 rounded toggle-step" />
                                        <label for="new-task-recurring-${goal.id}" class="ml-2 text-sm text-gray-700">Daily Recurring Task</label>
                                    </div>
                                    <button onclick="handleAddStep('${goal.id}')" class="w-full bg-${color}-600 hover:bg-${color}-700 text-white py-2 rounded-lg text-sm">Add Task</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-3 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                            <button type="button" onclick="handleToggleNestedDetails(this, 'goal-notes-content-${goal.id}')" class="w-full text-left flex justify-between items-center text-sm font-bold text-gray-700 hover:text-${color}-600">
                                <span>Notes</span>
                                <svg class="w-4 h-4 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <div id="goal-notes-content-${goal.id}" class="details-container mt-2">
                                <div class="pt-2">
                                    <h4 class="text-sm font-semibold text-gray-700 flex justify-between items-center mb-1">Goal Notes
                                        <button data-goal-id="${goal.id}" data-is-editing="false" onclick="handleEditNotes(this)" class="edit-notes-btn text-xs text-${color}-600 hover:text-${color}-800 font-medium px-2 py-0.5 rounded-md bg-white border border-gray-200">Edit</button>
                                    </h4>
                                    <div class="notes-display text-sm text-gray-600 whitespace-pre-wrap px-1">${goal.notes || 'No notes added.'}</div>
                                    <div class="notes-edit hidden mt-2">
                                        <textarea rows="3" class="notes-textarea w-full p-2 border border-${color}-300 rounded-lg text-sm focus:ring-${color}-500 focus:border-${color}-500 transition duration-150">${goal.notes || ''}</textarea>
                                        <div class="flex justify-end space-x-2 mt-2">
                                            <button onclick="handleCancelNotes('${goal.id}', this)" class="px-3 py-1 text-sm font-medium text-gray-700 bg-white rounded-lg border border-gray-300">Cancel</button>
                                            <button onclick="handleSaveNotes('${goal.id}', this.closest('.notes-edit').querySelector('.notes-textarea').value)" class="px-3 py-1 text-sm font-medium text-white bg-${color}-600 rounded-lg">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button onclick="showDeleteModal('${goal.id}', '${escapeHtml(goal.name)}')" class="w-full text-red-600 hover:bg-red-50 text-sm font-semibold py-2 rounded-xl border border-red-300">Delete Goal</button>
                        </div>
                    </div>
                </div>
            `;

            return tile;
        };

        // Helper to escape single quotes in onclick strings
        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/'/g, "\\'");
        }

        // HANDLERS

        const handleToggleDetails = (goalId) => {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            goal.isExpanded = !goal.isExpanded;
            renderGoals();
        };

        const handleToggleStep = (goalId, stepId, isChecked) => {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            const step = goal.steps.find(s => s.id === stepId);
            if (!step) return;
            const today = getTodayDateString();

            if (step.isRecurring) {
                step.completionLog = step.completionLog || [];
                if (isChecked) {
                    if (!step.completionLog.includes(today)) step.completionLog.push(today);
                } else {
                    step.completionLog = step.completionLog.filter(d => d !== today);
                }
            } else {
                step.isCompleted = isChecked;
            }
            saveGoals();
        };

        const handleAddStep = (goalId) => {
            const descEl = document.getElementById(`new-task-desc-${goalId}`);
            const startEl = document.getElementById(`new-task-start-date-${goalId}`);
            const endEl = document.getElementById(`new-task-end-date-${goalId}`);
            const recEl = document.getElementById(`new-task-recurring-${goalId}`);

            if (!descEl) {
                showStatusMessage('Add-task inputs not found.');
                return;
            }

            const description = descEl.value.trim();
            if (!description) {
                showStatusMessage('Task description is required!');
                return;
            }

            const newStep = {
                id: generateId(),
                description,
                isCompleted: false,
                isRecurring: recEl ? recEl.checked : false,
                completionLog: recEl && recEl.checked ? [] : null,
                startDate: startEl ? startEl.value : '',
                endDate: endEl ? endEl.value : '',
            };

            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            goal.steps.push(newStep);
            saveGoals();
            // clear UI inputs if present
            if (descEl) descEl.value = '';
            if (startEl) startEl.value = '';
            if (endEl) endEl.value = '';
            if (recEl) recEl.checked = false;
        };

        const handleEditNotes = (button) => {
            const container = button.closest('[data-goal-id]');
            const goalId = container.getAttribute('data-goal-id');
            const isEditing = button.getAttribute('data-is-editing') === 'true';

            const notesSection = button.closest('.pt-2') || button.closest('.details-container').querySelector('.pt-2');
            // Try locating in slightly different DOM if needed
            const wrapper = container.querySelector(`#goal-notes-content-${goalId} .pt-2`) || container.querySelector('.pt-2');
            if (!wrapper) {
                // fallback: toggle based on button state
                if (isEditing) {
                    button.textContent = 'Edit';
                    button.setAttribute('data-is-editing','false');
                } else {
                    button.textContent = 'Editing...';
                    button.setAttribute('data-is-editing','true');
                }
                return;
            }
            const notesDisplay = wrapper.querySelector('.notes-display');
            const notesEdit = wrapper.querySelector('.notes-edit');
            const notesTextarea = wrapper.querySelector('.notes-textarea');

            if (isEditing) {
                notesDisplay.classList.remove('hidden');
                notesEdit.classList.add('hidden');
                button.textContent = 'Edit';
                button.setAttribute('data-is-editing', 'false');
            } else {
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    if (notesTextarea) notesTextarea.value = goal.notes || '';
                    notesDisplay.classList.add('hidden');
                    notesEdit.classList.remove('hidden');
                    button.textContent = 'Editing...';
                    button.setAttribute('data-is-editing', 'true');
                }
            }
        };

        const handleSaveNotes = (goalId, newNotes) => {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            goal.notes = newNotes.trim();
            saveGoals();
            // close edit UI: find edit button and toggle back
            const goalDiv = document.querySelector(`[data-goal-id="${goalId}"]`);
            const editBtn = goalDiv ? goalDiv.querySelector('.edit-notes-btn') : null;
            if (editBtn) handleEditNotes(editBtn);
        };

        const handleCancelNotes = (goalId, btn) => {
            const goalDiv = document.querySelector(`[data-goal-id="${goalId}"]`);
            const editBtn = goalDiv ? goalDiv.querySelector('.edit-notes-btn') : null;
            if (editBtn) handleEditNotes(editBtn);
        };

        const deleteGoal = (goalId) => {
            goals = goals.filter(g => g.id !== goalId);
            saveGoals();
            hideModal();
        };

        // Modal logic
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let pendingDeleteId = null;

        const showDeleteModal = (goalId, goalName) => {
            pendingDeleteId = goalId;
            modalTitle.textContent = 'Delete Goal';
            modalMessage.textContent = `Are you sure you want to delete "${goalName}"? This action cannot be undone.`;
            modalConfirmBtn.textContent = 'Confirm Delete';
            modal.classList.remove('hidden');
            modal.onclick = hideModal;
        };

        const hideModal = () => {
            modal.classList.add('hidden');
            pendingDeleteId = null;
        };
        modalConfirmBtn.onclick = () => { if (pendingDeleteId) deleteGoal(pendingDeleteId); };
        modalCancelBtn.onclick = hideModal;
        document.getElementById('modal-content').onclick = (e) => e.stopPropagation();

        // Draft steps functions
        const renderStepsDraft = () => {
            const list = document.getElementById('steps-draft-list');
            list.innerHTML = '';
            if (stepsDraft.length === 0) return;
            stepsDraft.forEach((step, idx) => {
                const datesHtml = (step.startDate || step.endDate) ? `<div class="text-xs text-gray-500">Start: ${formatDate(step.startDate)} • Target: ${formatDate(step.endDate)}</div>` : '';
                const recurringTag = step.isRecurring ? `<span class="text-xs font-semibold text-blue-500 bg-blue-100 px-2 py-0.5 rounded-full ml-2">Daily</span>` : '';
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm p-2 bg-white rounded-lg border border-gray-100 shadow-sm';
                li.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-gray-700 truncate">${idx+1}. ${step.description} ${recurringTag}</div>
                        ${datesHtml}
                    </div>
                    <button type="button" onclick="handleRemoveStepDraft('${step.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full">✕</button>
                `;
                list.appendChild(li);
            });
        };

        const handleAddStepDraft = () => {
            const desc = document.getElementById('new-step-desc').value.trim();
            const start = document.getElementById('new-step-start-date').value;
            const end = document.getElementById('new-step-end-date').value;
            const recurring = document.getElementById('new-step-recurring').checked;
            if (!desc) { showStatusMessage('Task description is required for draft!'); return; }
            stepsDraft.push({
                id: generateId(),
                description: desc,
                isCompleted: false,
                isRecurring: recurring,
                completionLog: recurring ? [] : null,
                startDate: start,
                endDate: end,
            });
            renderStepsDraft();
            document.getElementById('new-step-desc').value = '';
            document.getElementById('new-step-start-date').value = '';
            document.getElementById('new-step-end-date').value = '';
            document.getElementById('new-step-recurring').checked = false;
        };

        const handleRemoveStepDraft = (idToRemove) => {
            stepsDraft = stepsDraft.filter(s => s.id !== idToRemove);
            renderStepsDraft();
        };

        // Form submission to create goal
        const handleAddGoal = (e) => {
            e.preventDefault();
            const name = document.getElementById('goal-name').value.trim();
            const type = document.getElementById('goal-type').value;
            const start = document.getElementById('goal-start').value;
            const end = document.getElementById('goal-end').value;
            const notes = document.getElementById('goal-notes').value.trim();

            if (!name) { showStatusMessage('Goal name cannot be empty!'); return; }

            const newGoal = {
                id: generateId(),
                name,
                type,
                startDate: start,
                endDate: end,
                notes,
                steps: [...stepsDraft],
                createdAt: new Date().toISOString(),
                isExpanded: true
            };

            goals.push(newGoal);
            saveGoals();

            // reset form
            document.getElementById('goal-name').value = '';
            document.getElementById('goal-type').value = 'daily';
            document.getElementById('goal-start').value = getTodayDateString();
            document.getElementById('goal-end').value = '';
            document.getElementById('goal-notes').value = '';
            stepsDraft = [];
            renderStepsDraft();

            // collapse add form
            const formContent = document.getElementById('add-goal-form-content');
            const toggleFormBtn = document.getElementById('toggle-add-form');
            if (formContent && formContent.classList.contains('expanded')) {
                formContent.classList.remove('expanded');
                const svg = toggleFormBtn.querySelector('svg');
                if (svg) svg.classList.remove('rotate-180');
            }
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadGoals();
            renderGoals();
            renderStepsDraft();

            document.getElementById('goal-start').value = getTodayDateString();

            document.getElementById('add-goal-form').addEventListener('submit', handleAddGoal);
            document.getElementById('add-step-draft-btn').addEventListener('click', handleAddStepDraft);

            // toggles
            const setupToggle = (buttonId, contentId) => {
                const button = document.getElementById(buttonId);
                const content = document.getElementById(contentId);
                if (button && content) {
                    const svg = button.querySelector('svg');
                    button.addEventListener('click', () => {
                        content.classList.toggle('expanded');
                        if (svg) svg.classList.toggle('rotate-180');
                        button.setAttribute('aria-expanded', content.classList.contains('expanded'));
                    });
                }
            };
            setupToggle('toggle-add-form', 'add-goal-form-content');
            setupToggle('toggle-notes', 'notes-container');
        });
    </script>
</body>
</html>
